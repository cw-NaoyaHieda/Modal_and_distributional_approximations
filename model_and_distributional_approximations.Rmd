---
title: "Modal and distributional approximations"
date: "`r Sys.Date()`"
author: Naoya Hieda
output:
  rmdformats::readthedown:
    highlight: kate
    toc_depth: 2
    css: "toc.css"
    pandoc_args: [
        "--from", "markdown+autolink_bare_uris+tex_math_single_backslash-implicit_figures"
        ]
---


```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)

## Global options
options(max.print="75")
opts_chunk$set(echo=FALSE,
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=75)
```

最初に、低次元の問題でのシミュレーション手法について説明する。 複雑なモデルでは、事後分布からのサンプルを直接得ることはできない。第11章と第12章では、このようなモデルで使用できる反復シミュレーションアルゴリズムについて説明した。 この章では、分布近似に基づくさまざまなアプローチについて説明する。 これらの方法は、迅速な推論、マルコフ連鎖シミュレーションアルゴリズムの開始点、反復シミュレーションアプローチが遅すぎる大きな問題に役立つ。   記述する近似は比較的計算が簡単なもので、モデルの近似に関する貴重な情報を提供していく。  

13.1節では、事後モード(posterior mode)を見つけるためのアルゴリズムについて説明する。分布近似を構築する上で有用であること以外にも、事後モードは統計的実践において，ポイント推定値として使用されることが多く、時には（前の密度の対数がペナルティ関数とみなされる)ペナルティ尤度推定のように見える。 13.2項では、modeによって事後分布を要約することが目標である場合、フルベイジアン推論で使用されるものとは異なる事前分布を使用することができる話をする。   13.3節では、モードを中心とした正規分布と混合正規分布の近似を示す。13.4-13.6章は、EM（expectation maximization）と関連する方法を用いて、事後モードを見つけるための方法を紹介する。最後に、13.7節と13.8節では、変分ベイズと期待伝播を紹介する。条件付きモーメントに基づいて分布への近似を構築する2つの方法を紹介する。

## 13.1 モードを見つける

ベイズ計算では，事後密度のマッピングを開始する方法としてモードを探す。
特に、事後密度の最大点を求めること自体に特別な関心はない。 多くのモードが存在する場合、それらをすべて見つけようとするか、少なくともそれらの近隣に無視できない後方質量?(posterior mass)を伴うモードを見つけようとするべきである。 実際には、最初に単体のモードを探索し、それが実質的な意味で妥当でないと思われる場合は、引き続き他のモードのパラメータ空間を探索する。 すべてのローカルモードを見つけたり、見つかったモードが唯一の重要なモードであることを確認するには、異なる開始点から数回モード探索アルゴリズムを実行する必要がある。

可能であれば、パラメータのサブセットの周辺事後密度のモードを見つけることがさらに良い。 その後、残りのパラメータの分布を分析し、条件付きで第1の部分集合を決定する。 セクション13.4と13.5でこのトピックをもう一度扱う。
最適化問題を解くための数値計算法は数多く存在し、いずれも事後密度のモードを見つけるために原理的に適用することができる。 この膨大なトピックを包括的にカバーするのではなく、統計的な問題でよく使われる2つの簡単な方法を紹介する。

### 条件付き最大化

モードを見つける最も簡単な方法は、段階的な上昇とも呼ばれる条件付きの最大化である。単純にパラメータを大まかな見積もりで設定するなど、ターゲット分布のどこかで開始してから、一度に1つの$\theta$の成分を変更し、他の成分を以前の値のままで、各ステップでlogの事後密度を増加させる。事後密度が限定されていると仮定すると、ステップは最終的にはローカルモードに収束する。  
loglinearモデル（項16.7を参照）の反復比例フィッティング?(iterative proportional fitting)の方法は、条件付き最大化の例である。複数のモードを探索するには、パラメータ空間全体に広がったさまざまな点から始まる条件付き最大化ルーチンを実行する。ただし、パラメータの大まかな見積もりと、パラメータの合理的な範囲に関する問題固有の知識に基づいて、合理的な出発点の範囲を見つけることが可能でなければならない。   
多くの標準統計モデルでは、他のすべてのパラメータが与えられた各パラメータの条件付き分布は簡単な解析形式を持ち、容易に最大化される。この場合、条件付き最大化アルゴリズムを適用するのは簡単である。一度に1セットのパラメータに対して密度を最大化し、ステップが収束して近似収束に達するまで繰り返す。普通の(normalな)階層的なモデルの例については、13.6節でこのプロセスを説明する。

### ニュートン法  

Newton-Raphsonアルゴリズムとも呼ばれるNewton法は、
対数事後尤度の二次テイラー級数近似で、
$$
L(\theta) = log p(\theta|y).
$$
ニュートン法は$L（\theta）$の導関数のみを使用し、pの任意の乗法定数はLの加法の定数であるため、正規化されていない事後密度を使用することも許容される。第4章で見てきたように、二次の近似は データポイントの数がパラメータの数に対して大きい場合にはかなり正確である。 まず、関数$L '（\theta）$と$L''(\theta)$を求める。関数のベクトルと二次微分の行列はそれぞれ事後密度の対数である。
微分係数は、分析的または数値的に決定することができる。 モード探索アルゴリズムは次のように進行する。

- 開始値$\theta^0$を選択する。 
- $t = 1,2,3\dots$
    - $L'(\theta_{t-1})$と$L''(\theta_{t-1})$を計算する。時刻tにおけるニュートン法のステップは、$\theta_{t-1}$を中心とする$L（\theta）$に対する二次近似に基づく。
    - 二次近似を最大にするために新しい反復$\theta_t$を設定する。 したがって

$$\theta^t=\theta^{t-1} - [L''（\theta^{t-1})]^{-1}L' （θ^{t-1}）$$

開始値$\theta_0$は重要である。 アルゴリズムは、特に$-L ''$が正定値でない問題では、すべての開始値から収束することが保証されていない。 開始値は粗パラメータ推定値(crude parameter)から得ることができ、条件付き最大化を用いてニュートン法の開始値を生成することができる。 ニュートン法の利点は、二次近似が正確であるとき，反復が解に近ければ収束が非常に速いこと。 反復が収束しない場合、多くの場合はパラメータ空間の端に向かって素早く移動するので、次のステップは新たな開始点で再試行する。

### Quasi-Newton and conjugate gradient methods

ニュートン方での$-L''$の計算と保存にはコストがかかるかもしれない。 Broyden-Fletcher-Goldfarb-Shanno（BFGS）法のような準ニュートン法は、勾配情報のみを用いて反復的に$-L''$の近似を形成する。
共役勾配法は勾配情報のみを使用するが、最急降下の代わりに後続の最適化方向は共役方程式を使用して形成される。 共役勾配は、ニュートン法や準ニュートン法よりも反復回数が多くなるが、繰り返し回数が少なくなり、必要な記憶量も少なくなる。

### Numerical computation of derivatives

対数事後密度の第一次微分と第二微分を理論的に決定することが困難な場合、有限差分を用いて数値的にそれらを近似することができる。$L'$の各成分は，任意の指定値$\theta=（\theta_1、...、\theta_d）$で数値的に推定することができる。

$$
L'_i(\theta) = dL ≈ L(\theta + \delta_i e_i|y) − L(\theta − \delta_i e_i|y),
$$
ここで、$\delta_i$は小さな値であり、線形代数表記を使用して、$e_i$は$\theta$のi番目の成分に対応する単位ベクトルである。 $\delta_i$の値は、問題の規模に基づいて選択される。 通常、0.0001などの値は、微係数を近似するのに十分低く、コンピュータの丸め誤差を回避するのに十分高い値である。 $\theta$における二次微分行列は、差分を再度適用することによって数値的に推定される。 各i、jについて：

$$
L''(\theta)=\frac{d^2L}{d\theta_i d\theta_j} = \frac{d}{d\theta_j}(\frac{dL}{d\theta_i})\\
\approx \frac{L_i'(\theta + \delta_je_j|y) − L′_i(\theta − \delta_je_j|y)}{2\delta_j} \\
\approx[L(\theta+δiei +δjej)−L(\theta−\delta_ie_i +\delta_je_j)\\
 −L(\theta + \delta_ie_i − \delta_je_j) + L(\theta − \delta_ie_i − \delta_je_j)]/(4\delta_i\delta_j).  \hspace{10mm}(13.2)
$$


## 13.2 モデル要約の事前分布による境界?(boundry)回避

### パラメータ空間の境界(boundry)における事後モード

後方モードは対称事後分布の良い点の要約である。   しかし、事後分布が非対称である場合、モードは不良点推定となり得る。
たとえば、次の図のように8つの学校の例におけるグループレベルの尺度パラメータの事後分布を考えてみる。 

![](fig/school.png)
![](fig/school2.png)

(周辺)事後分布のモードは$\tau= 0$であり、これは、大学入学試験における教育の効果が、8つの学校すべてで同じであるモデルに対応する。 この結論は、データと一致している（ゼロが後方モードであることが示されている）が、実際の根拠によれば、まったくゼロであるとは信じられない(8つの学校の教育プログラムは異なり、 効果も少しは違うはずなので。)

ベイズ全体の観点からは、図13.1に示す事後分布は問題ではない。 $\tau$の事前分布に一様分布を用いる事は、このパラメータが任意に小さい事を可能にするが、しかし、我々は$\tau=0$という事象にはゼロ確率を正確に割り当てる。 得られた事後分布は連続空間上で定義され、無作為シミュレーション、またはポイント要約が必要な場合は事後メディアン（この例では4.9の妥当な値を取る）によって要約することができる。
周辺尤度のモードがゼロになる問題は、8つの学校の例だけで生じる訳ではない。 J = 10のグループを使って、抜粋した例を示す。

$$
y_j \sim N(\theta_j,1), for j = 1,...,J,
$$

簡略化のため、0を中心とする正規分布を有する$\theta_j'$をモデル化する。

$$
\theta_j' \sim N(0,\tau^2).
$$


シミュレーションでは、$\tau=0.5$と仮定する。


このモデルから、1000個のシミュレートされたデータセットyを作成する。 それぞれについて、周辺尤度とそれが最大になる値を決定する。
![](fig/school3.png)

図13.2aは、$\tau$の最大周辺尤度推定値の$\tau=0.5$の分布からのサンプリング分布を示している（この単純な例では、
$\hat{\tau}$は$\hat{\tau}=0 if \frac{1}{J}\sum_{j=1}^J y^2 <1$という境界制約の上で，$1+\hat{\tau}^2=\frac{1}{J}\sum_{j=1}^J y_j^2$で解く。)
 
 
100個のシミュレーション結果から$\tau$の推定分布を示した図13.2bを見ると、ほぼ半分のシミュレーションで、
周辺尤度は$\hat{\tau}=0$で最大になる。
ここでは十分なnoiseが含まれており、グループレベルの差異を超えて何もする事ができない。 このデータからは正確な推定ができない。

### グループレベルの分散パラメータで0を避ける事前分布

この問題は、モードが事後の要約であると扱うために発生する。モードで事後分布を要約する場合、それを踏まえて事前分布を選択する事が理にかなっている。
では、学校の問題のような境界推定を避ける、適切な非常的事前分布とは何か  
先ずは$\tau=0$の確率を0にする。  
正の確率変数に対する便利な確率モデルには、対数正規分布や逆正規分布があり、これは我々が検討しているモデルでも共役である。残念ながら?、これらの分布は0付近で急激に切断される。
対数正規分布や逆ガンマ分布は有効下限を持ち、その下限を下回ると急激に先行密度が低下しゼロ付近の$\tau$を効果的に遮断する。これらのモデルのスケールパラメータが十分に曖昧に設定されている場合は，この下限を極端に低く出来るが、その前に強く尖らせられる。 したがって、これらのモデルでは合理的なデフォルトの設定はない。
ゼロ付近の$\tau$の値を排除するあいまいな事前選択、またはデータのスケールに関して非常に有益な分布を選択する必要がある。

代わりに我々は、$Gamma(2,\frac{2}{A})$などのshape=2のガンマ分布、もしくはより多くのパラメータを持つ分布を好む。
![](fig/Gamma_distribution_pdf.svg)
![](fig/sample_gamma.png)

 この密度は、$\tau= 0$のときに0から始まり、そこから直線的に増加し、最終的には$\tau$の大きな値に対して穏やかにゼロに戻る。$\tau=0$での線形な振る舞いは、尤度がどれほど集中していても、事後分布は対数正規分布または逆ガンマ事前分布を保持しない特性であるデータと一致することを保証する。

ここでもまた、この事前分布の目的は、階層モデルを用いた統計的計算でよくあるように、$\tau$の正の分布をそのモードで要約するときに良い見積もりを与えることである。

 事後シミュレーションの使用を計画していたとしても、ガンマ事前分布には何の利点も見られず、第5章で議論されているように、デフォルトの選択肢として均一または半Cauchyを使用する。

### 相関パラメータの境界回避事前分布

次に、2×2群レベルの分散行列を用いて変化する切片、変化する勾配回帰の単純なモデルを用いて、相関パラメータを推定することの困難性を説明する。

各グループ$j = 1,\dots,J$で線形モデルを仮定する：
$$y_{ij} \sim N(\theta_{j1}+\theta_{j2}x_i,1), for i=1,...,n_j.$$

シミュレーションでは$x_i$を文から独立に抽出し、全てのjに対して$n_j=5$とする。先ほどはj=10で行った。

jの各グループでの二つの回帰パラメータは正規分布からランダムに取り出す。
$$
\left(
     \begin{array}{r}  
          \theta_{j1} \\
          \theta_{j2} \\
        \end{array}
    \right)\sim
    N\left(\left(
    \begin{array}{r}  
          0 \\
          0 \\
        \end{array}
    \right),
    \left(
    \begin{array}{rr}  
          \tau_1^2 & p\tau_1\tau_2 \\
           p\tau_1\tau_2 & \tau_2^2 \\
        \end{array}
        \right)
    \right)
$$
先ほどの例では、線形パラメータ$\theta$を平均とし、周辺分布用いて、分析的に計算する事が出来る
$$
p(y|\tau_1,\tau_2,\rho)=N(\hat{\theta_j}|0,V_j+T)
$$
ここで$\hat{\theta_j},V_j$は、最小二乗推定量であり、対応する共分散行列は、グループjのデータについてxをyに回帰することから、
$$T=\left(\begin{array}{rr}\tau_1^2 & p\tau_1\tau_2 \\
           p\tau_1\tau_2 & \tau_2^2 \\
        \end{array}
        \right)$$

この例では、分散パラメータの真の値を$\tau_1=\tau_2=0.5$と$\rho=0$と仮定している。$\rho$の推定値を安定させ、境界から遠ざけるという目標のためには、真の値を0に設定する必要があり、最良の場合のシナリオを選んでいる。 しかし、ここでも、問題がある。

先ほどと同様に、データをシミュレートし、1000回の周辺尤度を計算する。
この例では、$\rho$に焦点を当てているので、$(\tau_1,\tau_2,\rho)$の最大周辺尤度推定値における$\rho$の値を見て、$\rho$のプロファイル尤度も見る。 すなわち関数$L_{profile}(\rho|y)=max_{tau_1,\tau_2}p(y|\tau_1,\tau_2,\rho)$である。
![](fig/profile.png)

回帰モデルの標準であるように、これらの定義はすべてxに対して暗黙的に条件付きであり、14.1節でさらに論じる点である。
シミュレーションごとに、グリッド内の各$\rho$に個別に適用される数値最適化ルーチンを使用して、プロファイル尤度を$\rho$の関数として計算する。周辺尤度関数は閉じた形で書くことができるので、最適化は容易である。
均一な事前分布$(\tau_1,\tau_2,\rho)$を平均化し$\rho$の周辺事後密度は、解決するためにより多くの努力を要するが、同様の結果をもたらすであろう。
図13.4に結果を示す。
![](fig/13_4.png)
1000回のシミュレーションでは、グループレベル相関の最大周辺尤度推定値は10％にわたって境界$(\rho=\pm1)$にあり、プロファイルの$\rho$の周辺尤度は一般的にあまり有益ではない。
ベイズ全体の設定では、$\rho$を平均化する。 罰則を課された可能性のある枠組みでは、より安定したポイント見積もりが望まれる。
$\rho$の事後モードによる推論を要約する予定であれば、U(−1,1)の事前分布を$p(\rho)\propto(1-\rho)(1+\rho)$で置き換える。これは、変換されたパラメータ$\frac{\rho+ 1}{2}$のBeta（2,2）に相当する。
事前および結果の事後密度は境界でゼロであり、したがって事後モードは-1か1になることはなる。しかし、このセクションの前半で説明した$Gamma(2,\frac{2}{A})$の事前分布と同様に、$\rho$の事前密度は境界付近で線形であり、従って尤度に反することはない。

### 縮退 - 共分散行列の事前分布を避ける

より一般的には、モードベースの点推定または共分散行列の計算近似を非縮退、すなわち正の分散パラメータと正定相関行列とすることが望ましい。
ここでも、共分散行列が縮退しているときにゼロになる事前密度を選択することによって、後方モードでこの特性を保証することができる。
上記の1次元および2次元解と同様に、一般的なd×d共分散行列では、ゼロであるが境界で正の定数導関数を有する$Wishart(d+3,AI)$事前密度を選択する。
これまでのように、問題の状況に基づいてAを大きな値に設定することができる。
結果として得られる共分散行列の推定値は、常に正定値であるが、尤度によってそれらがサポートされている場合、境界付近の推定値を除外することはない。
Aの大きな値の限界では、共分散行列上のWishart(d+3,AI)事前分布は、$\delta\rightarrow 0$での、各固有値上の独立したガンマ(2,$\delta$)事前分布に対応し、したがって、上記の分散パラメータのデフォルトモデルの一般化として見ることができる。
2次元では、$A\rightarrow \infty$の周辺多変量モデルは、先ほどのように事前分布$p(\rho)\propto(1+\rho)(1-\rho)$に対応する。  
また、共分散行列の推論を事後モードで要約したり近似したりするならば、既定のWishart事前分布族を非情報的選択として参照します。
完全なベイジアン推論の場合、境界でゼロになる事前分布を選択する必要はない。
5.7節で論じたHalf・Cauchy事前分布を一般化するスケーリングされた逆Wishartモデルのようなものが好まれるだろう。 

## 13.3 正規分布と関連する混合分布

### モードの曲率に基づいて多変量正規分布を当てはめる

モードが見つかったら（前節で説明した境界回避の事前分布を含んだ後に）、（多変量）正規分布に基づいて近似を作成することができる。
簡単にするために、最初に$\theta$における単一モードの場合を考える。ここで、$\theta$における対数事後密度関数の最初の2つの導関数に正規分布を適合させる。

$$
P_{normal\hspace{2mm}approx}(\theta) = N(\hat{\theta} | V_\theta)
$$
分散行列は、モードにおける対数後部密度の曲率の逆数であり、$V_\theta\left[- \frac{d^2 log p(\theta|y)}{d\theta^2}|_{\theta=\hat{\theta}} \right]^{-1}$であり、この二次導関数は、いくつかの問題について解析的に計算することができ、あるいは（13.2）のように数値で近似することができる。  
いつものように、正規分布を当てはめる前に、対数とその逆関数を使ってパラメータを適切なものに変換することが理にかなっているので、それらはほぼ対称的な分布を持つ実線全体で定義される(事後密度を 1.8節のように変換されたヤコビ行列)。  

### ラプラスの積分の解析近似法

ラプラス法を用いて、平滑関数の積分を事後確率$h(\theta)p(\theta| y)$に近似することができる。近似は$\theta$における（多変量）正規密度に比例し、その積分はちょうど
$$
approximation\hspace{2mm}of\hspace{2mm} E(h(\theta)|y):h(\theta_0|y)(2\pi)^{d/2}|-u''(\theta_0)|^{1/2},
$$
ここでdは$\theta$の次元であり，$u(\theta)=log(h(\theta)p(\theta|y))$で、$\theta_0$は$u(\theta)$が最大値をとる$\theta$である。
$h(\theta)$がかなり平滑な関数であり，サンプルサイズが大きい場合、この近似は、事後分布の近似の正規性$p(\theta| y)$のために妥当である可能性がある。
ラプラスの方法は正規性に基づいているので、単一モードの後部密度、またはマルチモーダル密度の各モードに別々に適用する場合に最も効果的である。
ラプラスの方法を使用して、密度の相対質量を、マルチモーダル密度（13.4）に対する正規混合近似で計算する。

### 正規化されていない密度を用いたラプラスの方法 

非正規化された密度$q(\theta|y)$のみを計算できれば、ここで分子と分母を評価するために、ラプラスの方法を$hq$と$q$に別々に適用することができる。
$$
E(h(\theta)|y)=\frac{\int h(\theta)q(\theta|y)d\theta}{\int q(\theta|y) d\theta}
$$

### マルチモーダル密度の混合近似

今度は、事後密度においてK点のモードを見つけたとする。
事後分布は、$K$個の多変量正規分布の混合によって近似することができ、各々はそれ自身のモード$\theta$、分散行列$V$、および相対質量$\omega$を有する。
よって目標密度$p(\theta|y)$

$$
P_{normal\hspace{2mm}approx}(\theta)\propto \sum_{k=1}^{K}\omega_k N(\theta|\hat{\theta_k},V_{\theta k}).
$$
各kについて、多変量正規混合物のk番目の成分の質量$\omega_k$は、K個のモードの各々において事後密度$p(\theta_k|y)$または正規化されていない事後密度$q(\theta_k|y)$を近似である $P_{normal\hspace{2mm}approx}(\theta)$に等しくすることによって推定する事ができる。

モードがかなり離れており、正規の近似が各モードに適切である場合、
$$
\omega_k = q(\theta^k|y)|V_{\theta k}|^{1/2} \hspace{10mm}(13.4)
$$
これは正規混合近似をもたらし
$$
p_{normal\hspace{2mm}approx}(\theta)\propto \sum_{k=1}^{K}q(\hat{\theta}^k|y)exp(-\frac{1}{2}(\theta - \hat{\theta}_k)^TV_{\theta k}^{-1}(\theta-\hat{\theta}_k))
$$

### 正規ではなく多変量t近似

より広範な分布の場合、いくつかの小さな自由度$v$を有する多変量tによって各正規密度を置き換えることができる。

対応する近似は、関数形式を有する混合密度関数である

$$
p_{t\hspace{2mm}approx}(\theta)\propto \sum_{k=1}^{K}q(\hat{\theta}^k|y)exp
(v + (\theta + \hat{\theta}_k)^TV_{\theta k}^{-1}(\theta-\hat{\theta}_k))^{-(d+v)/2},
$$

ここでdは$\theta$の次元である．いくつかの例では、近似密度に対して3つの有限モーメントを提供するv=4のような値が機能した。  
分布のサドルポイントやテールなどのモード以外の場所に近似を当てはめるなど、近似分布をさらに改善するためのいくつかの戦略を使用することができる。 いくつかの構成要素を分析的または数値的に統合する。 第13.7節と第13.8節で説明するが、変分ベイズや期待伝搬などの反復スキームに移行することができる。

### 近似的な事後分布からのサンプリング

多変量正規分布またはt混合近似から無作為標本を抽出するのは簡単である。
近似から単一のサンプルを生成するには、まず混合成分の相対確率質量$\omega_k$を多項式確率として用いてK個の混合成分の1つを選択する。
付録Aでは、スケール行列のコレスキー分解を使用して、1つの多変量正規分布またはt分布からサンプルを抽出する方法の詳細を示している。
近似的な事後分布から抽出されたサンプルは、重要なサンプリングに使用することができる。または、セクション10.4で説明しているように、重要なリサンプリングを使用して改良されたサンプルを得ることができる。

## 13.4 EMを用いて周辺事後モードを見つける

多くのパラメータの問題では、結合分布への通常の近似はしばしば役に立たず、結合分布のモードは通常役に立たない。しかし、パラメータのサブセットの境界事後モードに近似を基づかせることは、しばしば有用である。私たちは表記法$\theta=(\gamma,\phi)$を使用して、$p(\phi|y)$を最初に近似することに興味があるとしよう。$p(\phi|y)$を正規またはtまたはそれらの混合物として近似した後、$\phi$に依存するパラメータを用いて条件分布pを正規分布（またはtまたは混合物）として近似することができる。このセクションでは最初の問題に取り組んでおり、次のセクションでは2番目の問題に取り組んでいる。






